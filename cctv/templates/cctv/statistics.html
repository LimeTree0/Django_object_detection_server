<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<h1>로그 페이지입니다</h1>

{#통계 기간 지정#}
<form action="/statistics/date" , method="GET">
    <input type="date" id="dateFrom" name="dateFrom"></input>
    <input type="date" id="dateTo" name="dateTo"></input>
    <input type="button" onclick="drawGraph()" value="전송">
</form>

{#    막대 그래프 차트#}
<canvas id="ObjectStickChart"></canvas>
<canvas id="ObjectLineChart"></canvas>
<canvas id="ObjectDoughnutChart"></canvas>
{#json으로 파싱하면서 더 이상 작동 안함#}
{#<table>#}
{#    {% for log in loglist %}#}
{#        <ul>#}
{#            <li>{{ log.log }}</li>#}
{#            <li>{{ log.time|date:'Y-m-d H:i' }}</li>#}
{#            <li>{{ log.location }}</li>#}
{#        </ul>#}
{#    {% endfor %}#}
{#</table>#}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="http://code.jquery.com/jquery-3.5.1.min.js"></script>
<script type="text/javascript">

    // ajax를 이용해 로그 데이터를 받는다. 받은 데이터는

    var lineChart = null;

    function drawGraph() {
    function getLog() {
        var log = "";
        var dateFrom = document.getElementById('dateFrom').value;
        var dateTo = document.getElementById('dateTo').value;
        $.ajax({
            url: 'http://127.0.0.1:8000/statistics/dateDetail?dateFrom=' + dateFrom + '&dateTo=' + dateTo,
            async: false,
            dataType: "JSON",
            success: function (data) {
                log = JSON.parse(data);
            },
        });

        return log;
    }


    // 다음과 같은 방식으로 접근 가능(log[index]["fields"].databaseAttribute)
    // index는 log 배열의 인덱스이다
    // json은 model, pk, fields로 나누어진다.
    // fields는 json의 fields이다.(fileds 안에 실제 데이터가 들어가 있음)
    // databaseAttribute는 실제 데이터베이스에 있는 속성이다.
    var log = getLog();

    // log로 부터 탐지 객체 로그 파싱 후 objectDict에 저장
    /*
    for (var i = 0; i < log.length; i++) {
        var logtemp = log[i]['fields'].log;
        var json_log = JSON.parse(logtemp);
        var keys = Object.keys(json_log);
        keys.forEach(function (key) {
            if (objectDict[key] === undefined)
                objectDict[key] = json_log[key];
            else
                objectDict[key] += json_log[key];

        })
    }*/

    console.log(log);

    // 로그 데이터 저장 배열. 필요 없는 데이터(모델 정보, pk등 )를 없앤 로그 데이터 배열
    var logArr = [];
    // 탐지 객체 저장 딕셔너리
    var objectDict = {};

    for (var i = 0; i < log.length; i++) {
        var logtemp = log[i]['fields'].log;
        var json_log = JSON.parse(logtemp);
        var keys = Object.keys(json_log);
        var objectDictTemp = {};
        keys.forEach(function (key) {
            // 로그데이터 배열에 로그 데이터 저장
            if (objectDictTemp[key] === undefined)
                objectDictTemp[key] = json_log[key];

            // 탐지 객체 딕셔너리에 탐지 내용 저장
            if (objectDict[key] === undefined)
                objectDict[key] = json_log[key];
            else
                objectDict[key] += json_log[key];

        });
        logArr[i] = [log[i]["fields"].time, log[i]["fields"].location, json_log];
    }

    // 키 set과 data set으로 분리
    var labels = Object.keys(objectDict);
    var data = Object.keys(objectDict).map(function (key) {
        return objectDict[key];
    })

    console.log(labels)

    // 막대 그래프 생성 스크립트
    const ctx = document.getElementById('ObjectStickChart');

    // 막대 차트 그리기
        if(lineChart !== null) lineChart.destroy();
    lineChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '탐지 개수',
                    data: data,
                    borderWidth: 1,
                    borderColor: "#3e95cd"
                },
                {
                    label: '탐지 개수',
                    data: [100, 25, 77, 58, 44, 234],
                    borderWidth: 1,
                    borderColor: "#3ee345"
                }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
        /*
    // 꺽은 선 그래프
    new Chart(document.getElementById('ObjectLineChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '탐지 개수',
                    data: data,
                    borderWidth: 1,
                    borderColor: "#3e95cd"
                },
                {
                    label: '탐지 개수',
                    data: [100, 25, 77, 58, 44, 234],
                    borderWidth: 1,
                    borderColor: "#3ee345"
                }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // 도넛 그래프
    new Chart(document.getElementById('ObjectDoughnutChart'), {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '탐지 개수',
                    data: data,
                    borderWidth: 1,
                    borderColor: "#3e95cd",
                    backgroundColor: [
                        "#2248d4",
                        "#677a8a",
                        "#31ab4e",
                        "#c7e373",
                        "#cc67bb",
                        "#e32d2d",
                    ]
                },
                {
                    label: '탐지 개수',
                    data: [100, 25, 77, 58, 44, 234],
                    borderWidth: 1,
                    borderColor: "#3ee345",
                    backgroundColor: [
                        "rgba(34,72,212,0.4)",
                        "rgba(103,122,138,0.34)",
                        "rgba(49,171,78,0.38)",
                        "rgba(199,227,115,0.3)",
                        "rgba(204,103,187,0.26)",
                        "rgba(227,45,45,0.25)",
                    ]
                }]
        },
    });*/
}
</script>

</body>
</html>